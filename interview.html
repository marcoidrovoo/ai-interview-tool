<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Interview</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-3xl border border-gray-200">
      <h2 id="interview-title" class="text-2xl font-bold mb-6 text-gray-900 text-center"></h2>
      <div id="chat" class="space-y-4 mb-6 max-h-[400px] overflow-y-auto bg-gray-50 p-4 rounded-lg border border-gray-200"></div>
      <form id="responseForm" class="flex gap-4">
        <input
          type="text"
          id="userInput"
          class="flex-grow border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Type your response..."
          required
        />
        <button
          type="submit"
          class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition"
        >
          Send
        </button>
      </form>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const name = params.get("name") || "Candidate";
      const role = params.get("role") || "this role";
      const company = params.get("company") || "a company";
      const plan = params.get("plan") || "free";
      const tone = params.get("tone") || "friendly";

      const questions = [];
      const answers = [];
      let currentQuestion = 0;

      const chat = document.getElementById("chat");
      const form = document.getElementById("responseForm");
      const input = document.getElementById("userInput");
      const title = document.getElementById("interview-title");

      const managerName = ["Jordan", "Taylor", "Dana", "Chris", "Alex"][Math.floor(Math.random() * 5)];
      title.textContent = `Interview with ${managerName} – Hiring Manager at ${company}`;

      addMessage(`Hi, I'm ${managerName}, a hiring manager at ${company}. Thanks for taking the time today. Let’s get started.`, "ai");

      generateInterviewQuestion(role, company).then((question) => {
        questions.push(question);
        addMessage(question, "ai");
      });

      async function generateInterviewQuestion(role, company) {
        const conversationHistory = [];
        for (let i = 0; i < questions.length; i++) {
          conversationHistory.push({ role: "assistant", content: questions[i] });
          conversationHistory.push({ role: "user", content: answers[i] });
        }

        const systemPrompt = `
You're a ${tone} hiring manager at ${company}, conducting a mock interview for a ${role} role.

This is a live back-and-forth interview. Only play the role of the hiring manager.

- Start with one realistic interview question.
- Wait for the candidate to respond.
- Then reply naturally to their answer and ask a thoughtful follow-up.
- Respond as if you're in a real conversation — empathetic, blunt, or formal depending on tone.
- Vary your tone slightly across responses to reflect human nuance.
- Keep each message short (1-4 sentences).
- Do NOT speak for the candidate or combine your reply with their response.

Never include the candidate’s answer in your message.
Always end with one new follow-up question.
`;


        const response = await fetch("https://ai-interview-tool.onrender.com/api/interview", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "gpt-3.5-turbo",
            messages: [
              { role: "system", content: systemPrompt.trim() },
              ...conversationHistory
            ],
            temperature: 0.75,
          }),
        });

        const data = await response.json();
        return data.reply;
      }

      async function generateFinalReport(answers, role, company) {
        const joinedAnswers = answers.map((ans, i) => `Q${i + 1}: ${questions[i]}\nA${i + 1}: ${ans}`).join("\n\n");

        const prompt = `
You're a brutally honest, no-fluff hiring manager at ${company}. You just finished interviewing a candidate for the ${role} position.

Please write a highly critical evaluation based on the following interview transcript. Your tone should be professional but blunt.

Include:
- Major weaknesses in bullet form
- Direct feedback about poor or lazy responses
- Why the candidate is or is not hirable
- A final score out of 10 (don’t be generous)

Transcript:
${joinedAnswers}`;

        const response = await fetch("https://ai-interview-tool.onrender.com/api/interview", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "gpt-3.5-turbo",
            messages: [{ role: "system", content: prompt.trim() }],
            temperature: 0.7,
          }),
        });

        const data = await response.json();
        return data.reply;
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const userText = input.value.trim();
        if (!userText) return;

        addMessage(userText, "user");
        input.value = "";
        answers.push(userText);

        currentQuestion++;
        const maxQuestions = plan === "premium" ? 15 : 5;

        if (currentQuestion < maxQuestions) {
          const followUp = await generateInterviewQuestion(role, company);
          questions.push(followUp);
          addMessage(followUp, "ai");
        } else {
          addMessage("Thanks for your responses. Let me review them and generate your personalized feedback report...", "ai");
          form.style.display = "none";
          const report = await generateFinalReport(answers, role, company);
          formatFinalReport(report);
        }
      });

      function formatFinalReport(text) {
        const sections = text.split(/\n(?=\*\*|Final Score:)/g);
        sections.forEach((section) => {
          const card = document.createElement("div");
          card.className = "bg-gray-50 p-4 rounded-lg shadow-sm border mb-4 text-sm text-gray-800 whitespace-pre-wrap";
          card.textContent = section.trim();
          chat.appendChild(card);
        });

        const upgradeNote = document.createElement("p");
        upgradeNote.className = "text-center text-sm text-gray-500 mt-6";
        upgradeNote.innerHTML = `Want deeper feedback, smart follow-ups, and downloadable reports?<br><a href="pricing.html" class="text-blue-600 underline hover:text-blue-800">Upgrade to Premium</a>`;
        chat.appendChild(upgradeNote);
        chat.scrollTop = chat.scrollHeight;
      }

      function addMessage(text, sender) {
        const bubble = document.createElement("div");
        bubble.className = sender === "ai"
          ? "bg-gray-200 text-gray-800 p-3 rounded-lg max-w-lg self-start"
          : "bg-blue-600 text-white p-3 rounded-lg max-w-lg self-end";
        bubble.textContent = text;
        chat.appendChild(bubble);
        chat.scrollTop = chat.scrollHeight;
      }
    </script>
  </body>
</html>
